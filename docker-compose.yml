services:
  homeassistant:
    container_name: homeassistant
    image: homeassistant/home-assistant:latest
    volumes:
      - ./homeassistant/config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    environment:
      - TZ=${TIMEZONE:-America/New_York}
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    depends_on:
      - mariadb
      - mosquitto

  mariadb:
    container_name: homeassistant-mariadb
    image: mariadb:latest
    volumes:
      - ./mariadb/data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-homeassistant}
      - MYSQL_USER=${MYSQL_USER:-homeassistant}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    restart: unless-stopped

  mosquitto:
    container_name: homeassistant-mosquitto
    image: eclipse-mosquitto:latest
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    ports:
      - "1883:1883"
      - "9001:9001"
    restart: unless-stopped

  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    environment:
      - TZ=${TIMEZONE:-America/New_York}
      - WEBPASSWORD=${PIHOLE_PASSWORD:-admin}
      - FTLCONF_LOCAL_IPV4=${PIHOLE_SERVER_IP}
      - PIHOLE_DNS_=1.1.1.1;8.8.8.8
      - WEB_PORT=8089
      - DNSMASQ_LISTENING=local
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN

  nodered:
    container_name: nodered
    image: nodered/node-red:latest
    environment:
      - TZ=${TIMEZONE:-America/New_York}
    volumes:
      - ./nodered/data:/data
    ports:
      - "1880:1880"
    restart: unless-stopped

  wyze-bridge:
    container_name: wyze-bridge
    image: mrlt8/wyze-bridge:latest
    network_mode: host
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      - WYZE_EMAIL=${WYZE_EMAIL}
      - WYZE_PASSWORD=${WYZE_PASSWORD}
      - API_ID=${API_ID}
      - API_KEY=${API_KEY}
      - WB_AUTH=False
      - WB_IP=192.168.4.22
    volumes:
      - ./wyze-bridge:/config
    restart: unless-stopped

  frigate:
    container_name: frigate
    image: ghcr.io/blakeblackshear/frigate:stable
    privileged: true
    shm_size: "256mb"
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - ./frigate/config:/config
      - ./frigate/storage:/media/frigate
      - /etc/localtime:/etc/localtime:ro
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000
    ports:
      - "5000:5000"  # Frigate Web UI
      - "8555:8555/tcp"  # WebRTC over tcp
      - "8555:8555/udp"  # WebRTC over udp
    environment:
      - TZ=${TIMEZONE:-America/New_York}
      - FRIGATE_RTSP_PASSWORD=${FRIGATE_RTSP_PASSWORD:-password}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video
    restart: unless-stopped
    depends_on:
      - mosquitto
      - wyze-bridge
